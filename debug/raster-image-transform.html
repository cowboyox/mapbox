<!DOCTYPE html>
<html>
<head>
    <title>Mapbox GL JS debug page</title>
    <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel='stylesheet' href='../dist/mapbox-gl.css' />
    <style>
        body { margin: 0; padding: 0; }
        html, body, #map { height: 100%; }
        .dg.a {
            float: left !important;
        }
    </style>
</head>

<body>
<div id='map'></div>
<script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js'></script>
<script src='../dist/mapbox-gl-dev.js'></script>
<script src='../debug/access_token_generated.js'></script>
<script type="module">
import * as Comlink from "https://unpkg.com/comlink/dist/esm/comlink.mjs"; // eslint-disable-line

var map = window.map = new mapboxgl.Map({
    container: 'map',
    zoom: 12.5,
    center: [-122.4194, 37.7749],
    style: 'mapbox://styles/mapbox/empty-v9',
    hash: true,
    rasterFadeDuration: 0
});

const worker = new Worker('./image-transform-worker.js');
const UTILS = Comlink.wrap(worker);

map.on('load', () => {
    map.addSource('dem-custom', {
        "type": "raster",
        "url": "mapbox://mapbox.terrain-rgb",
        "tileSize": 256
    });

    map.addSource('mapbox-dem', {
        "type": "raster-dem",
        "url": "mapbox://mapbox.mapbox-terrain-dem-v1",
    });

    const rasterSource = map.getSource('dem-custom');
    rasterSource.setImageTransformer((img, tileId) => {
        return new Promise((resolve, reject) => {
            resolve(img);
        });
    });

    const params = {
        interpolation: 'NONE',
        min: 0,
        max: 8000,
        terrain: false,
        useWorker: false
    };

    const updateTransformer = function() {
        if (params.useWorker) {
            rasterSource.setImageTransformer((img, tileId) => {
                return UTILS.transformImg({params, img});
            });
        } else {
            // Work on main-thread
            if (params.interpolation === 'NONE') {
                rasterSource.setImageTransformer((img, tileId) => {
                    return new Promise((resolve, reject) => {
                        resolve(img);
                    });
                });
            } else {
                rasterSource.setImageTransformer((img, tileId) => {
                    const transformedImage = new Uint8Array(img.data);
                    const MIN = params.min;
                    const MAX = params.max;
                    for (let i = 0; i < img.data.length / 4; i++) {
                        const R = img.data[4 * i];
                        const G = img.data[4 * i + 1];
                        const B = img.data[4 * i + 2];
                        const elevation = -10000 + ((R * 256 * 256 + G * 256 + B) * 0.1);
                        const t = Math.min(1, Math.max(0, elevation / (MAX - MIN)));

                        const transformedColor = d3.rgb(d3[`interpolate${params.interpolation}`](t)); // eslint-disable-line

                        transformedImage[4 * i] = transformedColor.r;
                        transformedImage[4 * i + 1] = transformedColor.g;
                        transformedImage[4 * i + 2] = transformedColor.b;
                    }

                    return new Promise((resolve, reject) => {
                        resolve({data: transformedImage, width: img.width, height: img.height});
                    });
                });
            }
        }
    };

    const gui = new dat.GUI(); // eslint-disable-line

    const interpolation = gui.add(params, 'interpolation', [
        'NONE',
        'Blues',
        'Greens',
        'Greys',
        'Oranges',
        'Turbo',
        'Inferno',
        'Cividis',
        'OrRd',
        'Rainbow'
    ]);
    interpolation.onFinishChange((value) => {
        updateTransformer();
    });

    const min = gui.add(params, 'min', -10000, 10000);
    min.onFinishChange((value) => {
        updateTransformer();
    });

    const max = gui.add(params, 'max', -10000, 10000);
    max.onFinishChange((value) => {
        updateTransformer();
    });

    const enable3dTerrain = gui.add(params, 'terrain');
    enable3dTerrain.onFinishChange(() => {
        if (params.terrain) {
            map.setTerrain({"source": "mapbox-dem"});
        } else {
            map.setTerrain(null);
        }
    });
    const useWorker = gui.add(params, 'useWorker');
    useWorker.onFinishChange(() => {
        updateTransformer();
    });

    map.addLayer({
        "id": "dem-custom-layer",
        "source": "dem-custom",
        "type": "raster",
        "paint": {
            "raster-fade-duration": 0
        }
    });

});

</script>
</body>
</html>
